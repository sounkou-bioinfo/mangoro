#!/bin/sh
# check the go installation with go version command
# before which we use R do detect architecture
 
 > config.log

# Restore flatbuf files from tools/ to vendor directory during installation
if [ -d "tools/flatbuf" ] && [ ! -d "inst/go/vendor/github.com/apache/arrow/go/v18/arrow/internal/flatbuf" ]; then
  echo "***********************************************************************" >> config.log
  echo "Restoring flatbuf files from tools/flatbuf..." >> config.log
  echo "***********************************************************************" >> config.log
  mkdir -p inst/go/vendor/github.com/apache/arrow/go/v18/arrow/internal/flatbuf
  cp -r tools/flatbuf/* inst/go/vendor/github.com/apache/arrow/go/v18/arrow/internal/flatbuf/
  echo "Flatbuf files restored." >> config.log
fi
## detect architecture using R
OS=`"${R_HOME}/bin/Rscript" -e "cat(unlist(R.version)[['os']])"`
ARCH=`"${R_HOME}/bin/Rscript" -e "cat(unlist(R.version)[['arch']])"`
echo "Detected OS: $OS, ARCH: $ARCH" >> config.log
# try to find go command using R's Sys.which
echo "Checking for Go command..." >> config.log
GO_CMD=`"${R_HOME}/bin/Rscript" -e "cat(Sys.which('go'))"`
GO_CMD=`echo "$GO_CMD" | tr -d '\n'`
GO_CMD=${GO_CMD:-go}
echo "Go command: $GO_CMD" >> config.log
# use "" because people may have spaces in path on windows
if ! "$GO_CMD" version >/dev/null 2>&1; then
echo "***********************************************************************" >> config.log
  echo "Go is not found on your system PATH" >> config.log
  echo "Please put it int the PATH or install Go (>= 1.22) for $OS and $ARCH" >> config.log
  echo "Visit https://golang.org/doc/install for installation instructions." >> config.log
  echo "for fully functional mangoro package, Go is required." >> config.log
  echo "***********************************************************************" >> config.log
fi
cat config.log